## 실행 컨텍스트와 스코프
- 변수나 함수의 실행 컨텍스트는 다른 데이터에 접근할 수 있는지, 어떻게 행동하는지를 규정
- 각 실행 컨텍스트에는 변수객체(variable object)가 연결되어 있으며 해당 컨텍스트에서 정의된 모든 변수와 함수는 이 객체에 존재
- 실행 컨텍스트는 포함된 코드가 모두 실행될 때 파괴되고, 컨텍스트 내부에서 정의된 변수와 함수도 함께 파괴
- 함수를 실행하면 독자적인 컨텍스트가 생성되고, 코드의 실행이 함수로 들어갈 때마다 함수의 컨텍스트가 컨텍스트 스택에 쌓이며 함수 실행이 끝나면 해당 컨텍스트를 스택에서 꺼내고 컨트롤을 이전 컨텍스트에 반환
<br/>


### 전역 컨텍스트
- 가장 바깥쪽에 존재하는 실행 컨텍스트 
- ECMAScript 를 구현한 환경에 따라 부르는 이름이 다름
- 웹 브라우저에서는 window 라 부르며 전역 변수와 함수는 모두 window 객체의 프로퍼티 및 메서드로 생성
- 전역 컨텍스트는 애플리케이션이 종료될 때, 웹페이지에서 나가거나 브라우저를 닫을 때 까지 유지
<br/>


### 스코프 체인 (scope chain)
- 컨텍스트에서 코드를 실행하면 변수 객체에 만들어지는 것
- 실행 컨텍스트가 접근할 수 있는 모든 변수와 함수에 순서를 정의하기 위한 의도
- 스코프 체인의 앞쪽은 항상 코드가 실행되는 컨텍스트의 변수 객체
  - 컨텍스트가 함수인 경우 '활성화 객체(activation object)'를 변수 객체로 사용
  - 활성화 객체는 항상 arguments 변수 단 하나로 시작 (이 변수는 전역 컨텍스트에는 존재하지 않음)
- 변수 객체의 다음 순서는 해당 컨텍스트를 포함하는 컨텍스트(부모 컨텍스트)이며, 전역 컨텍스트에 도달할 때까지 계속 반복
- 전역 컨텍스트의 변수 객체는 항상 스코프 체인의 마지막에 존재
- 식별자를 찾을 때에는 스코프 체인 순서를 따라가면서 해당 식별자 이름을 검색    
```javascript
var color = "blue";
function changeColor(){
  if (color == "blue") {
    color = "red";
  } else {
    color = "blue";
  }
}
```
- changeColor()의 스코프 체인에는 두개의 객체 존재
  - 함수 자체의 변수 객체 (arguments 객체는 여기에 정의)
  - 전역 컨텍스트의 변수 객체    
- 변수 color 는 함수의 스코프 체인에서 찾을 수 있으므로 접근 가능 
```javascript
var color = "blue";

function changeColor() {
  var anotherColor = "red";
  
  function swapColors() {
    var tempColor = anotherColor;
    anotherColor = color;
    color = tempColor;
    
    // color, anotherColor, tempColor 모두 접근 가능 
  }
 
  // color, anotherColor 접근 가능, tempColor 접근 불가능 
  swapColors();
}

// color 에만 접근 가능 
changeColor();
```
- 로컬 컨텍스트에서는 지역 변수와 전역 변수를 모두 쓸 수 있음 
- 세개의 실행 컨텍스트 존재
- 전역 컨텍스트, changeColor() 의 로컬 컨텍스트, swapColors()의 로컬 컨텍스트
- 전역 컨텍스트에는 color 변수와, changeColor() 함수가 포함
- changeColor()의 로컬 컨텍스트 스코프 체인에는 changeColor()의 변수객체, 전역 변수객체 존재
- swapColors()의 로컬 컨텍스트 스코프 체인에는 swapColors()의 변수객체, changeColor()의 변수객체, 전역 변수객체 존재
- 각각의 로컬 컨텍스트는 자신의 변수객체에서 변수나 함수 이름을 검색한 다음 찾지 못하면 스코프 체인을 따라 한 단계씩 올라감
- 함수 매개변수도 변수로 간주되어 실행 컨텍스트에 있는 다른 변수와 같은 규칙을 따름
<br/>


### 스코프 체인 확장
- 실행 컨텍스트에는 전역 컨텍스트와 함수 컨텍스트 두가지 타입만 있지만 스코프 체인을 확장하는 방법 존재
- 스코프 체인 앞 부분에 임시로 변수 객체를 만들며 해당 변수 객체는 코드 실행이 끝나면 사라짐
  - try-catch 문의 catch 블록
  - with 문
```javascript
  function buildUrl(){
    var qs = "?debug=true";
    
    with(location){
      var url = href + qs;
    }
    
    return url;
  }
```
<br/>


### 블록 레벨 스코프
- 자바스크립트는 블록 레벨 스코프를 지원하지 않음
- 블록 레벨 스코프를 지원하는 언어에서는 for 문의 초기화 부분에서 선언한 변수가 오직 for 문의 컨텍스트 안에서만 존재
- 자바스크립트에서는 for문에서 생성한 i변수가 루프 실행이 끝난 후에도 존재 
- 실행 컨텍스트에 추가 되기 때문 (아래에서는 전역 컨텍스트)
```javascript
for(var i = 0; i < 10; i++0) {
  doSomething(i);
}

alert(i); // 10
```

#### 변수 선언
- var 를 사용해서 선언한 변수는 자동으로 가장 가까운 컨텍스트에 추가됨
- 함수 내부에서는 함수의 로컬 컨텍스트가 가장 가까운 컨텍스트
- 변수를 선언하지 않은채 초기화하면 해당 변수는 자동으로 전역 컨텍스트에 추가
- 스트릭트 모드에서는 변수를 선언하지 않은 채 값을 할당해 초기화하면 에러
```javascript
function add1(num1, num2) {
  var sum1 = num1 + num2;
  return sum1;
}

var result1 = add1(10, 20);  // 30
alert(sum1);                // sum 은 유효한 변수가 아니므로 에러 발생 (함수의 실행 컨텍스트).

function add2() {
  sum2 = num1 + num2;
  return sum2;
}

var result2 = add2(10, 20);  // 30
alert(sum2);                // 30 (전역 컨텍스트).
``` 
<br/>


### 식별자 검색
- 컨텍스트 안에서 식별자를 참조하기 위해서 검색부터 해야함
- 검색은 스코프 체인 앞에서 시작하며 주어진 이름으로 식별자를 찾음
- 로컬 컨텍스트에서 식별자 이름을 찾으면 검색을 멈추고 변수를 설정
  - 식별자가 로컬 컨텍스트에 정의되어 있으면 부모 컨텍스트에 같은 이름의 식별자가 있다 해도 참조할 수 없음
- 로컬 컨텍스트에서 찾지 못하면 스코프 체인을 따라 검색을 계속해서 전역 컨텍스트의 변수 객체에 도달할때 까지 진행
  - 스코프 체인 내부의 객체에 프로토타입 체인이 있으므로 각 객체의 프로토타입 체인을 따라 검색을 계속함
  - 전역 컨텍스트의 변수 객체에서도 식별자를 찾지 못하면 정의되지 않은 것으로 판단
```javascript
var color = "blue";
function getColor() {
  var color = "red";
  return color;
}

alert(getColor());  // "red"
```
- color를 지역 변수로 선언한 후에는 해당 컨텍스트에서 전역 컨텍스트의 color 변수를 사용할 수 없음
- 전역 컨텍스트의 color 변수를 이용하려면 window.color 라고 명시해야 함
- 변수 검색에도 비용이 들어가며 지역 변수는 스코프 체인을 따라 올라가며 검색할 필요가 없으므로 전역 변수보다 빨리 검색됨 
